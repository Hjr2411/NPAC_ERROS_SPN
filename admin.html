<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - NPAC Errors</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: #333;
      font-size: 1.8em;
    }

    .btn-logout {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-logout:hover {
      background: #c82333;
    }

    .admin-panel {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .admin-section {
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }

    .admin-section:last-child {
      border-bottom: none;
    }

    .admin-section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.4em;
    }

    .info-text {
      background: #e7f3ff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      color: #004085;
      font-size: 14px;
      border-left: 4px solid #004085;
    }

    .form-group {
      margin-bottom: 15px;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 10px;
    }

    input[type="file"] {
      display: block;
      width: 100%;
      padding: 12px;
      border: 2px dashed #667eea;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 10px;
      background: #f8f9ff;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }

    .preview {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }

    .preview h3 {
      color: #333;
      margin-bottom: 15px;
    }

    .preview-item {
      background: white;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }

    .preview-item strong {
      color: #667eea;
      display: block;
      margin-bottom: 5px;
    }

    .logs-container, .users-container {
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .logs-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .logs-table thead {
      background: #667eea;
      color: white;
      position: sticky;
      top: 0;
    }

    .logs-table th {
      padding: 12px;
      text-align: left;
    }

    .logs-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .users-list {
      list-style: none;
    }

    .users-list li {
      background: #f8f9fa;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-remove {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-remove:hover {
      background: #c82333;
    }

    .debug-console {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .debug-console div {
      margin-bottom: 5px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚öôÔ∏è Painel Administrativo</h1>
      <button id="backBtn" class="btn-logout">‚Üê Voltar ao Login</button>
    </div>

    <div class="admin-panel">
      <!-- Se√ß√£o 1: Adicionar Usu√°rio -->
      <div class="admin-section">
        <h2>üë§ Autorizar Novo Usu√°rio</h2>
        <div class="form-group">
          <input 
            type="text" 
            id="newUsername" 
            placeholder="Nome do usu√°rio (ex: joao_silva)"
            autocomplete="off"
          >
          <button id="addUserBtn" class="btn-primary">Adicionar Usu√°rio</button>
        </div>
        <div id="userMsg" class="message"></div>
      </div>

      <!-- Se√ß√£o 2: Importar Planilha -->
      <div class="admin-section">
        <h2>üìä Importar Planilha Excel</h2>
        <div class="info-text">
          <strong>üìã Formato esperado da planilha:</strong><br>
          Colunas obrigat√≥rias: <strong>Error_code</strong> | <strong>Descri√ß√£o em Portugu√™s</strong> | <strong>Description in English</strong>
        </div>
        <div class="form-group">
          <input type="file" id="excelFile" accept=".xlsx,.xls">
          <button id="importBtn" class="btn-primary">üì§ Importar Dados</button>
        </div>
        <div id="importMsg" class="message"></div>
        <div id="debugConsole" class="debug-console" style="display:none;"></div>
        <div id="preview" class="preview" style="display:none;"></div>
      </div>

      <!-- Se√ß√£o 3: Ver Logs -->
      <div class="admin-section">
        <h2>üìù Logs de Consultas (√öltimos 50)</h2>
        <button id="loadLogsBtn" class="btn-secondary">Carregar Logs</button>
        <div id="logsContainer" class="logs-container"></div>
      </div>

      <!-- Se√ß√£o 4: Usu√°rios Autorizados -->
      <div class="admin-section">
        <h2>üë• Usu√°rios Autorizados</h2>
        <button id="loadUsersBtn" class="btn-secondary">Carregar Usu√°rios</button>
        <div id="usersContainer" class="users-container"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Configura√ß√£o Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC99A9g4nMpYzujhzZiT2xUKfdN0MAkNGY",
      authDomain: "erro-npac-spn.firebaseapp.com",
      databaseURL: "https://erro-npac-spn-default-rtdb.firebaseio.com",
      projectId: "erro-npac-spn",
      appId: "1:568064054155:web:450e7769371ed7c6c1958e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Verificar se est√° autenticado E √© admin
    const currentUser = sessionStorage.getItem('currentUser');
    
    if (!currentUser) {
      alert('‚ö†Ô∏è Acesso negado! Fa√ßa login primeiro.');
      window.location.href = 'index.html';
    }

    // Verificar permiss√£o admin no Firebase
    async function checkAdminAccess() {
      try {
        const adminRef = ref(db, 'admin_users');
        const snapshot = await get(adminRef);
        const isAdmin = snapshot.exists() && snapshot.val()[currentUser] === true;
        
        if (!isAdmin) {
          alert('üö´ Acesso negado! Voc√™ n√£o tem permiss√£o de administrador.');
          window.location.href = 'user.html';
        } else {
          console.log('=== ADMIN PAGE ===');
          console.log('Usu√°rio admin:', currentUser);
        }
      } catch (error) {
        console.error('Erro ao verificar permiss√µes:', error);
        alert('Erro ao verificar permiss√µes. Redirecionando...');
        window.location.href = 'index.html';
      }
    }

    // Executar verifica√ß√£o
    checkAdminAccess();

    const backBtn = document.getElementById('backBtn');
    const newUsername = document.getElementById('newUsername');
    const addUserBtn = document.getElementById('addUserBtn');
    const userMsg = document.getElementById('userMsg');
    const excelFile = document.getElementById('excelFile');
    const importBtn = document.getElementById('importBtn');
    const importMsg = document.getElementById('importMsg');
    const preview = document.getElementById('preview');
    const debugConsole = document.getElementById('debugConsole');
    const loadLogsBtn = document.getElementById('loadLogsBtn');
    const logsContainer = document.getElementById('logsContainer');
    const loadUsersBtn = document.getElementById('loadUsersBtn');
    const usersContainer = document.getElementById('usersContainer');

    // Debug helper
    function log(message) {
      console.log(message);
      debugConsole.style.display = 'block';
      const div = document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      debugConsole.appendChild(div);
      debugConsole.scrollTop = debugConsole.scrollHeight;
    }

    // Voltar
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Mostrar mensagem
    function showMessage(element, text, type) {
      element.textContent = text;
      element.className = `message ${type}`;
    }

    // Adicionar usu√°rio
    async function addUser() {
      const username = newUsername.value.toLowerCase().trim().replace(/\s+/g, '_');
      
      if (!/^[a-z0-9_]{3,}$/.test(username)) {
        showMessage(userMsg, '‚ùå Nome inv√°lido', 'error');
        return;
      }

      try {
        const userRef = ref(db, `allowed_users/${username}`);
        await set(userRef, true);
        showMessage(userMsg, `‚úÖ Usu√°rio "${username}" autorizado com sucesso!`, 'success');
        newUsername.value = '';
      } catch (error) {
        showMessage(userMsg, `‚ùå Erro: ${error.message}`, 'error');
      }
    }

    addUserBtn.addEventListener('click', addUser);

    // Importar Excel
    async function importExcel() {
      const file = excelFile.files[0];
      
      if (!file) {
        showMessage(importMsg, '‚ùå Selecione um arquivo Excel', 'error');
        return;
      }

      log('üìÅ Arquivo selecionado: ' + file.name);
      showMessage(importMsg, '‚è≥ Lendo arquivo...', 'info');
      debugConsole.innerHTML = '';

      const reader = new FileReader();
      
      reader.onerror = () => {
        showMessage(importMsg, '‚ùå Erro ao ler arquivo', 'error');
        log('‚ùå Erro ao ler arquivo');
      };

      reader.onload = async (e) => {
        try {
          log('üìñ Processando dados do Excel...');
          
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          log(`üìä Planilhas encontradas: ${workbook.SheetNames.join(', ')}`);
          
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);

          log(`üìã Total de linhas: ${jsonData.length}`);

          if (jsonData.length === 0) {
            showMessage(importMsg, '‚ùå Planilha vazia', 'error');
            log('‚ùå Planilha sem dados');
            return;
          }

          // Mostrar primeira linha para debug
          const firstRow = jsonData[0];
          log('üîç Colunas detectadas: ' + Object.keys(firstRow).join(', '));

          // Validar colunas (buscar por diferentes varia√ß√µes)
          const possibleErrorCols = ['Error_code', 'error_code', 'ErrorCode', 'codigo', 'code', 'Code'];
          const possiblePtCols = ['Descri√ß√£o em Portugu√™s', 'Descricao em Portugues', 'Portugu√™s', 'Portugues', 'PT', 'pt'];
          const possibleEnCols = ['Description in English', 'English', 'EN', 'en', 'Ingles'];

          let errorCodeCol = possibleErrorCols.find(col => col in firstRow);
          let ptCol = possiblePtCols.find(col => col in firstRow);
          let enCol = possibleEnCols.find(col => col in firstRow);

          log(`‚úì Coluna c√≥digo: ${errorCodeCol || 'N√ÉO ENCONTRADA'}`);
          log(`‚úì Coluna PT: ${ptCol || 'N√ÉO ENCONTRADA'}`);
          log(`‚úì Coluna EN: ${enCol || 'N√ÉO ENCONTRADA'}`);

          if (!errorCodeCol || !ptCol || !enCol) {
            showMessage(importMsg, '‚ùå Planilha inv√°lida! Colunas esperadas: Error_code, Descri√ß√£o em Portugu√™s, Description in English', 'error');
            log('‚ùå Colunas obrigat√≥rias n√£o encontradas');
            return;
          }

          showMessage(importMsg, `‚è≥ Importando ${jsonData.length} registros...`, 'info');

          // Processar dados
          const errorsData = {};
          let importCount = 0;

          jsonData.forEach((row, index) => {
            const code = String(row[errorCodeCol] || '').trim();
            const pt = String(row[ptCol] || '').trim();
            const en = String(row[enCol] || '').trim();

            if (code && code !== '_init' && pt && en) {
              errorsData[code] = {
                code: code,
                pt: pt,
                en: en
              };
              importCount++;
              log(`‚úì Linha ${index + 1}: ${code}`);
            } else {
              log(`‚ö† Linha ${index + 1}: Dados incompletos, ignorada`);
            }
          });

          log(`üìä Total de erros v√°lidos: ${importCount}`);

          if (importCount === 0) {
            showMessage(importMsg, '‚ùå Nenhum registro v√°lido encontrado', 'error');
            return;
          }

          // Gravar no Firebase
          log('üíæ Gravando no Firebase...');
          const errorsRef = ref(db, 'errors');
          await set(errorsRef, errorsData);

          log('‚úÖ Dados gravados com sucesso!');
          showMessage(importMsg, `‚úÖ ${importCount} erros importados com sucesso!`, 'success');
          
          // Preview
          preview.style.display = 'block';
          const previewData = Object.values(errorsData).slice(0, 5);
          preview.innerHTML = `
            <h3>‚úÖ Preview dos primeiros 5 registros importados:</h3>
            ${previewData.map(err => `
              <div class="preview-item">
                <strong>C√≥digo: ${err.code}</strong>
                <div>üáßüá∑ PT: ${err.pt}</div>
                <div>üá∫üá∏ EN: ${err.en}</div>
              </div>
            `).join('')}
            <p style="margin-top:15px; color:#666;">
              <strong>Total importado:</strong> ${importCount} registros
            </p>
          `;
          
          excelFile.value = '';
        } catch (error) {
          console.error('Erro completo:', error);
          log('‚ùå ERRO: ' + error.message);
          showMessage(importMsg, `‚ùå Erro ao importar: ${error.message}`, 'error');
        }
      };

      reader.readAsArrayBuffer(file);
    }

    importBtn.addEventListener('click', importExcel);

    // Carregar logs
    async function loadLogs() {
      try {
        logsContainer.innerHTML = '‚è≥ Carregando...';
        const logsRef = ref(db, 'logs');
        const snapshot = await get(logsRef);

        if (!snapshot.exists()) {
          logsContainer.innerHTML = '<p>üì≠ Nenhum log encontrado</p>';
          return;
        }

        const logs = Object.entries(snapshot.val())
          .filter(([key]) => key !== '_init')
          .map(([key, log]) => ({ key, ...log }))
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
          .slice(0, 50);

        logsContainer.innerHTML = `
          <table class="logs-table">
            <thead>
              <tr>
                <th>Data/Hora</th>
                <th>Usu√°rio</th>
                <th>Consulta</th>
              </tr>
            </thead>
            <tbody>
              ${logs.map(log => `
                <tr>
                  <td>${new Date(log.timestamp).toLocaleString('pt-BR')}</td>
                  <td>${log.user}</td>
                  <td>${log.query}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        logsContainer.innerHTML = `<p class="message error">‚ùå Erro: ${error.message}</p>`;
      }
    }

    loadLogsBtn.addEventListener('click', loadLogs);

    // Carregar usu√°rios
    async function loadUsers() {
      try {
        usersContainer.innerHTML = '‚è≥ Carregando...';
        const usersRef = ref(db, 'allowed_users');
        const snapshot = await get(usersRef);

        if (!snapshot.exists()) {
          usersContainer.innerHTML = '<p>üì≠ Nenhum usu√°rio autorizado</p>';
          return;
        }

        const users = Object.keys(snapshot.val());

        usersContainer.innerHTML = `
          <ul class="users-list">
            ${users.map(user => `
              <li>
                <span>üë§ ${user}</span>
                <button class="btn-remove" data-user="${user}">Remover</button>
              </li>
            `).join('')}
          </ul>
        `;

        document.querySelectorAll('.btn-remove').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const username = e.target.dataset.user;
            if (confirm(`Remover usu√°rio "${username}"?`)) {
              try {
                const userRef = ref(db, `allowed_users/${username}`);
                await remove(userRef);
                loadUsers();
              } catch (error) {
                alert('Erro ao remover: ' + error.message);
              }
            }
          });
        });
      } catch (error) {
        usersContainer.innerHTML = `<p class="message error">‚ùå Erro: ${error.message}</p>`;
      }
    }

    loadUsersBtn.addEventListener('click', loadUsers);
  </script>
</body>
</html>
