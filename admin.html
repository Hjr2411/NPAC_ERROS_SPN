<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - NPAC Errors</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚öôÔ∏è Painel Administrativo</h1>
      <button id="backBtn" class="btn-logout">‚Üê Voltar ao Login</button>
    </div>

    <div class="admin-panel">
      <!-- Se√ß√£o 1: Adicionar Usu√°rio -->
      <div class="admin-section">
        <h2>üë§ Autorizar Novo Usu√°rio</h2>
        <div class="form-group">
          <input 
            type="text" 
            id="newUsername" 
            placeholder="Nome do usu√°rio (ex: joao_silva)"
            autocomplete="off"
          >
          <button id="addUserBtn" class="btn-primary">Adicionar Usu√°rio</button>
        </div>
        <div id="userMsg" class="message"></div>
      </div>

      <!-- Se√ß√£o 2: Importar Planilha -->
      <div class="admin-section">
        <h2>üìä Importar Planilha Excel</h2>
        <p class="info">
          A planilha deve conter as colunas: <strong>Error_code</strong>, 
          <strong>Descri√ß√£o em Portugu√™s</strong>, <strong>Description in English</strong>
        </p>
        <div class="form-group">
          <input type="file" id="excelFile" accept=".xlsx,.xls" class="file-input">
          <button id="importBtn" class="btn-primary">Importar Dados</button>
        </div>
        <div id="importMsg" class="message"></div>
        <div id="preview" class="preview"></div>
      </div>

      <!-- Se√ß√£o 3: Ver Logs -->
      <div class="admin-section">
        <h2>üìù Logs de Consultas (√öltimos 50)</h2>
        <button id="loadLogsBtn" class="btn-secondary">Carregar Logs</button>
        <div id="logsContainer" class="logs-container"></div>
      </div>

      <!-- Se√ß√£o 4: Usu√°rios Autorizados -->
      <div class="admin-section">
        <h2>üë• Usu√°rios Autorizados</h2>
        <button id="loadUsersBtn" class="btn-secondary">Carregar Usu√°rios</button>
        <div id="usersContainer" class="users-container"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { ref, get, set, push, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const backBtn = document.getElementById('backBtn');
    const newUsername = document.getElementById('newUsername');
    const addUserBtn = document.getElementById('addUserBtn');
    const userMsg = document.getElementById('userMsg');
    const excelFile = document.getElementById('excelFile');
    const importBtn = document.getElementById('importBtn');
    const importMsg = document.getElementById('importMsg');
    const preview = document.getElementById('preview');
    const loadLogsBtn = document.getElementById('loadLogsBtn');
    const logsContainer = document.getElementById('logsContainer');
    const loadUsersBtn = document.getElementById('loadUsersBtn');
    const usersContainer = document.getElementById('usersContainer');

    // Voltar
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Adicionar usu√°rio
    async function addUser() {
      const username = newUsername.value.toLowerCase().trim().replace(/\s+/g, '_');
      
      if (!/^[a-z0-9_]{3,}$/.test(username)) {
        showMessage(userMsg, '‚ùå Nome inv√°lido', 'error');
        return;
      }

      try {
        const userRef = ref(db, `allowed_users/${username}`);
        await set(userRef, true);
        showMessage(userMsg, `‚úÖ Usu√°rio "${username}" autorizado com sucesso!`, 'success');
        newUsername.value = '';
      } catch (error) {
        showMessage(userMsg, `‚ùå Erro: ${error.message}`, 'error');
      }
    }

    addUserBtn.addEventListener('click', addUser);

    // Importar Excel
    async function importExcel() {
      const file = excelFile.files[0];
      
      if (!file) {
        showMessage(importMsg, '‚ùå Selecione um arquivo Excel', 'error');
        return;
      }

      const reader = new FileReader();
      
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);

          if (jsonData.length === 0) {
            showMessage(importMsg, '‚ùå Planilha vazia', 'error');
            return;
          }

          // Validar colunas
          const firstRow = jsonData[0];
          const hasErrorCode = 'Error_code' in firstRow;
          const hasPT = 'Descri√ß√£o em Portugu√™s' in firstRow;
          const hasEN = 'Description in English' in firstRow;

          if (!hasErrorCode || !hasPT || !hasEN) {
            showMessage(importMsg, '‚ùå Planilha deve ter as colunas: Error_code, Descri√ß√£o em Portugu√™s, Description in English', 'error');
            return;
          }

          showMessage(importMsg, `‚è≥ Importando ${jsonData.length} registros...`, 'info');

          // Importar dados
          const errorsRef = ref(db, 'errors');
          const errorsData = {};

          jsonData.forEach(row => {
            const code = String(row['Error_code'] || '').trim();
            if (code && code !== '_init') {
              errorsData[code] = {
                code: code,
                pt: String(row['Descri√ß√£o em Portugu√™s'] || '').trim(),
                en: String(row['Description in English'] || '').trim()
              };
            }
          });

          await set(errorsRef, errorsData);

          showMessage(importMsg, `‚úÖ ${Object.keys(errorsData).length} erros importados com sucesso!`, 'success');
          
          // Preview
          preview.innerHTML = `
            <h3>Preview dos primeiros 5 registros:</h3>
            ${Object.values(errorsData).slice(0, 5).map(err => `
              <div class="preview-item">
                <strong>${err.code}</strong><br>
                PT: ${err.pt}<br>
                EN: ${err.en}
              </div>
            `).join('')}
          `;
          
          excelFile.value = '';
        } catch (error) {
          showMessage(importMsg, `‚ùå Erro ao importar: ${error.message}`, 'error');
        }
      };

      reader.readAsArrayBuffer(file);
    }

    importBtn.addEventListener('click', importExcel);

    // Carregar logs
    async function loadLogs() {
      try {
        logsContainer.innerHTML = '‚è≥ Carregando...';
        const logsRef = ref(db, 'logs');
        const snapshot = await get(logsRef);

        if (!snapshot.exists()) {
          logsContainer.innerHTML = '<p>üì≠ Nenhum log encontrado</p>';
          return;
        }

        const logs = Object.entries(snapshot.val())
          .filter(([key]) => key !== '_init')
          .map(([key, log]) => ({ key, ...log }))
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
          .slice(0, 50);

        logsContainer.innerHTML = `
          <table class="logs-table">
            <thead>
              <tr>
                <th>Data/Hora</th>
                <th>Usu√°rio</th>
                <th>Consulta</th>
              </tr>
            </thead>
            <tbody>
              ${logs.map(log => `
                <tr>
                  <td>${new Date(log.timestamp).toLocaleString('pt-BR')}</td>
                  <td>${log.user}</td>
                  <td>${log.query}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        logsContainer.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`;
      }
    }

    loadLogsBtn.addEventListener('click', loadLogs);

    // Carregar usu√°rios
    async function loadUsers() {
      try {
        usersContainer.innerHTML = '‚è≥ Carregando...';
        const usersRef = ref(db, 'allowed_users');
        const snapshot = await get(usersRef);

        if (!snapshot.exists()) {
          usersContainer.innerHTML = '<p>üì≠ Nenhum usu√°rio autorizado</p>';
          return;
        }

        const users = Object.keys(snapshot.val());

        usersContainer.innerHTML = `
          <ul class="users-list">
            ${users.map(user => `
              <li>
                <span>üë§ ${user}</span>
                <button class="btn-remove" data-user="${user}">Remover</button>
              </li>
            `).join('')}
          </ul>
        `;

        // Evento de remo√ß√£o
        document.querySelectorAll('.btn-remove').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const username = e.target.dataset.user;
            if (confirm(`Remover usu√°rio "${username}"?`)) {
              try {
                const userRef = ref(db, `allowed_users/${username}`);
                await remove(userRef);
                loadUsers();
              } catch (error) {
                alert('Erro ao remover: ' + error.message);
              }
            }
          });
        });
      } catch (error) {
        usersContainer.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`;
      }
    }

    loadUsersBtn.addEventListener('click', loadUsers);

    // Helper
    function showMessage(element, text, type) {
      element.textContent = text;
      element.className = `message ${type}`;
      element.style.display = 'block';
    }
  </script>
</body>
</html>
