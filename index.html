<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Consultar Erro NPAC SPN</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>Consultar Erro NPAC SPN</header>

<div class="container">
  <input id="nome" placeholder="Digite seu nome">
  <button id="btnEntrar">Entrar</button>

  <div id="areaConsulta" style="display:none">
    <input id="busca" placeholder="Erro em PT / EN / Código">
    <button id="btnConsultar">Consultar</button>
    <div id="resultado"></div>
  </div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { ref, get, push } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

let usuario = "";

document.getElementById("btnEntrar").onclick = async () => {
  const nome = document.getElementById("nome").value.trim().toLowerCase();

  if (!/^[a-zà-ÿ ]{3,}$/.test(nome)) {
    alert("Nome inválido");
    return;
  }

  const snap = await get(ref(db, "allowed_users/" + nome));
  if (!snap.exists()) {
    alert("Usuário não autorizado");
    return;
  }

  usuario = nome;
  document.getElementById("areaConsulta").style.display = "block";
};

document.getElementById("btnConsultar").onclick = async () => {
  const termo = document.getElementById("busca").value.toLowerCase();
  const snap = await get(ref(db, "errors"));
  let html = "";

  snap.forEach(e => {
    if (e.key === "_init") return;
    const d = e.val();
    if (
      d.pt.toLowerCase().includes(termo) ||
      d.en.toLowerCase().includes(termo) ||
      d.code.toLowerCase().includes(termo)
    ) {
      html += `
        <div class="result">
          <b>${d.code}</b><br>
          PT: ${d.pt}<br>
          EN: ${d.en}
        </div>`;
    }
  });

  document.getElementById("resultado").innerHTML = html || "Nenhum resultado.";

  await push(ref(db, "logs"), {
    user: usuario,
    query: termo,
    timestamp: new Date().toISOString()
  });
};
</script>

</body>
</html>
